The code concatenates the `dir` and user input `file_name` and sanitizes the `path` for path traversal vulnerability by first resolving it using `realpath` and makes sure that the resolved path still lies in the given `dir`, and then passes it to the `fopen`. This prevents the path traversal attack. 